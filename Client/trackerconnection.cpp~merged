#include "trackerconnection.h"

#include <QTcpSocket>
#include <QTimer>

<<<<<<< HEAD
TrackerConnection::TrackerConnection(const std::string& fileName)
	:socket(new QTcpSocket(this)), requestTimer(new QTimer(this)), torrent(fileName), request(torrent.getDict())
{
	connect(socket, SIGNAL(connected()), this, SLOT(start()));
	connect(requestTimer, SIGNAL(timeout()), this, SLOT(interval()));

	connectToTracker();
	initRequest();
=======
TrackerConnection::TrackerConnection(const std::string &fileName)
    :socket(new QTcpSocket(this)), requestTimer(new QTimer(this)), torrent(fileName), request(torrent.getDict())
{
    connect(socket, SIGNAL(connected()), this, SLOT(start()));
    connect(requestTimer, SIGNAL(timeout()), this, SLOT(interval()));

    connectToTracker();
    initRequest();
>>>>>>> 37bf64e56463140787433ca1479a2fa3175cac24
}

TrackerConnection::~TrackerConnection()
{
<<<<<<< HEAD
	stop();
	socket->disconnect();
=======
    stop();
    socket->disconnect();
>>>>>>> 37bf64e56463140787433ca1479a2fa3175cac24
}

void TrackerConnection::initRequest()
{
<<<<<<< HEAD
	request.setPeer_id("0");
	request.setPort(0);
	request.setUploaded(0);
	request.setDownloaded(0);
	request.setCompact(false);
	request.setNo_peer_id(false);
=======
    request.setPeer_id("0");
    request.setPort(0);
    request.setUploaded(0);
    request.setDownloaded(0);
    request.setCompact(false);
    request.setNo_peer_id(false);
>>>>>>> 37bf64e56463140787433ca1479a2fa3175cac24
}

void TrackerConnection::connectToTracker()
{
<<<<<<< HEAD
	bencode::Dict& torrentDict = (*torrent.getDict());

	bencode::String* announce = dynamic_cast <bencode::String*> (torrentDict["announce"].get());

	size_t pos = announce->find(L":");

	QString adress = QString::fromStdWString(announce->substr(0, pos));
	quint16 port = (quint16) QString::fromStdWString(announce->substr(pos + 1)).toUInt();

	socket->connectToHost(adress, port);
=======
    bencode::Dict &torrentDict = (*torrent.getDict());

    bencode::String* announce = dynamic_cast <bencode::String*> (torrentDict["announce"].get());

    size_t pos = announce->find(L":");

    QString adress = QString::fromStdWString(announce->substr(0, pos));
    quint16 port = (quint16) QString::fromStdWString(announce->substr(pos + 1)).toUInt();

    socket->connectToHost(adress, port);
>>>>>>> 37bf64e56463140787433ca1479a2fa3175cac24
}

void TrackerConnection::sendRequest()
{
<<<<<<< HEAD
	QByteArray data = QByteArray::fromStdString(request.getRequest());
	std::cout << data.size() << " " << request.getRequest().size() << std::endl;

	socket->write(data);
	socket->flush();
=======
    socket->write(QByteArray::fromStdString(request.getRequest()));
    socket->flush();
>>>>>>> 37bf64e56463140787433ca1479a2fa3175cac24
}

void TrackerConnection::start()
{
<<<<<<< HEAD
	if (!isActive)
	{
		isActive = true;
		request.setEvent("started");
		sendRequest();
	}
=======
    request.setEvent("started");
    sendRequest();
>>>>>>> 37bf64e56463140787433ca1479a2fa3175cac24
}

void TrackerConnection::stop()
{
<<<<<<< HEAD
	if (isActive)
	{
		isActive = false;
		request.setEvent("stopped");
		requestTimer->stop();
		sendRequest();
	}
=======
    request.setEvent("stoped");
    requestTimer->stop();
    sendRequest();
>>>>>>> 37bf64e56463140787433ca1479a2fa3175cac24
}

void TrackerConnection::completed()
{
<<<<<<< HEAD
	request.setEvent("completed");
	sendRequest();
=======
    request.setEvent("completed");
    sendRequest();
>>>>>>> 37bf64e56463140787433ca1479a2fa3175cac24
}

void TrackerConnection::interval()
{
<<<<<<< HEAD
	request.resetEvent();
	sendRequest();
	requestTimer->start();
=======
    request.resetEvent();
    sendRequest();
    requestTimer->start();
>>>>>>> 37bf64e56463140787433ca1479a2fa3175cac24
}

void TrackerConnection::read()
{

}
